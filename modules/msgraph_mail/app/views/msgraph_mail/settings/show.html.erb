<%#-- copyright
OpenProject MS Graph Mail Module
Copyright (C) 2025 Jan Hübener / DATAGROUP

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License version 3.
++#%>

<% html_title t(:label_administration), t("msgraph_mail.menu_title") %>

<h2><%= t("msgraph_mail.menu_title") %></h2>

<fieldset class="form--fieldset">
  <legend class="form--fieldset-legend"><%= t("msgraph_mail.settings.status") %></legend>
  
  <div class="form--field">
    <label class="form--label"><%= t("msgraph_mail.settings.delivery_method") %></label>
    <div class="form--field-container">
      <% if @is_active %>
        <strong style="color: green;">✓ <%= t("msgraph_mail.settings.active") %></strong>
      <% else %>
        <span style="color: #666;">○ <%= t("msgraph_mail.settings.inactive", current: @current_delivery_method || "none") %></span>
      <% end %>
    </div>
  </div>
</fieldset>

<fieldset class="form--fieldset">
  <legend class="form--fieldset-legend"><%= t("msgraph_mail.settings.configuration") %></legend>
  
  <p><%= t("msgraph_mail.settings.env_instructions_html").html_safe %></p>

  <table class="generic-table" style="margin-top: 1em;">
    <thead>
      <tr>
        <th><%= t("msgraph_mail.settings.variable") %></th>
        <th><%= t("msgraph_mail.settings.status") %></th>
        <th><%= t("msgraph_mail.settings.value") %></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>MSGRAPH_TENANT_ID</code></td>
        <td><%= @config&.tenant_id.present? ? "✓" : "✗" %></td>
        <td><%= @config&.tenant_id.present? ? "#{@config.tenant_id[0..7]}..." : "<em>Not set</em>".html_safe %></td>
      </tr>
      <tr>
        <td><code>MSGRAPH_CLIENT_ID</code></td>
        <td><%= @config&.client_id.present? ? "✓" : "✗" %></td>
        <td><%= @config&.client_id.present? ? "#{@config.client_id[0..7]}..." : "<em>Not set</em>".html_safe %></td>
      </tr>
      <tr>
        <td><code>MSGRAPH_CLIENT_SECRET</code></td>
        <td><%= @config&.client_secret.present? ? "✓" : "✗" %></td>
        <td><%= @config&.client_secret.present? ? "••••••••" : "<em>Not set</em>".html_safe %></td>
      </tr>
      <tr>
        <td><code>MSGRAPH_SENDER_EMAIL</code></td>
        <td><%= @config&.sender_email.present? ? "✓" : "✗" %></td>
        <td><%= @config&.sender_email.present? ? @config.sender_email : "<em>Not set</em>".html_safe %></td>
      </tr>
      <tr>
        <td><code>MSGRAPH_SENDER_NAME</code></td>
        <td>✓</td>
        <td><%= @config&.sender_name || "OpenProject" %></td>
      </tr>
    </tbody>
  </table>

  <% if @config&.valid? %>
    <div class="flash notice" style="margin-top: 1em;">
      ✓ <%= t("msgraph_mail.settings.configuration_complete") %>
    </div>
  <% else %>
    <div class="flash error" style="margin-top: 1em;">
      ✗ <%= t("msgraph_mail.settings.configuration_incomplete") %>
    </div>
  <% end %>
</fieldset>

<fieldset class="form--fieldset">
  <legend class="form--fieldset-legend"><%= t("msgraph_mail.settings.actions") %></legend>
  
  <div style="display: flex; gap: 1em; margin-top: 1em; flex-wrap: wrap;">
    <% if @config&.valid? %>
      <%= link_to t("msgraph_mail.settings.test_connection"),
                  test_connection_msgraph_mail_settings_path,
                  method: :post,
                  class: "button" %>
      
      <%= link_to t("msgraph_mail.settings.send_test_email"),
                  send_test_email_msgraph_mail_settings_path,
                  method: :post,
                  class: "button" %>
      
      <% if @is_active %>
        <%= link_to t("msgraph_mail.settings.deactivate"),
                    deactivate_msgraph_mail_settings_path,
                    method: :post,
                    class: "button -danger",
                    data: { confirm: t("msgraph_mail.settings.deactivate_confirm") } %>
      <% else %>
        <%= link_to t("msgraph_mail.settings.activate_msgraph"),
                    activate_msgraph_mail_settings_path,
                    method: :post,
                    class: "button -primary",
                    data: { confirm: t("msgraph_mail.settings.activate_confirm") } %>
      <% end %>
    <% else %>
      <p><em><%= t("msgraph_mail.settings.configure_first") %></em></p>
    <% end %>
  </div>
</fieldset>

<fieldset class="form--fieldset">
  <legend class="form--fieldset-legend"><%= t("msgraph_mail.settings.azure_setup") %></legend>
  
  <p><%= t("msgraph_mail.settings.azure_instructions") %></p>
  
  <ol style="margin-top: 1em; padding-left: 1.5em;">
    <li><%= t("msgraph_mail.settings.azure_step1_html").html_safe %></li>
    <li><%= t("msgraph_mail.settings.azure_step2") %></li>
    <li><%= t("msgraph_mail.settings.azure_step3") %></li>
    <li><%= t("msgraph_mail.settings.azure_step4") %></li>
    <li><%= t("msgraph_mail.settings.azure_step5") %></li>
  </ol>
  
  <h4 style="margin-top: 1.5em;"><%= t("msgraph_mail.settings.required_permissions") %></h4>
  <ul style="margin-top: 0.5em; padding-left: 1.5em;">
    <li><code>Mail.Send</code> - <%= t("msgraph_mail.settings.permission_mail_send") %></li>
  </ul>
</fieldset>
